<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrueBite - UC-02 Login Sequence Diagram</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
        }
        h1::before {
            content: "üîê";
            margin-right: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
        }
        .info-box {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .error-box {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .success-box {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        svg {
            width: 100%;
            max-width: 1150px;
            height: auto;
            margin: 20px 0;
        }
        .pseudocode {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            white-space: pre-wrap;
            line-height: 1.5;
        }
        .pseudocode .comment {
            color: #95a5a6;
        }
        .pseudocode .keyword {
            color: #e74c3c;
            font-weight: bold;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
        }
        td {
            padding: 10px;
            border-bottom: 1px solid #ecf0f1;
        }
        tr:hover {
            background: #f8f9fa;
        }
        .role-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin: 2px;
        }
        .customer { background: #3498db; color: white; }
        .vip { background: #f39c12; color: white; }
        .chef { background: #e74c3c; color: white; }
        .delivery { background: #9b59b6; color: white; }
        .manager { background: #2ecc71; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>TrueBite - UC-02: Log In</h1>
        
        <div class="info-box">
            <strong>Use Case:</strong> UC-02 - User Authentication & Login<br>
            <strong>Actors:</strong> 
            <span class="role-badge customer">Customer</span>
            <span class="role-badge vip">VIP</span>
            <span class="role-badge chef">Chef</span>
            <span class="role-badge delivery">DeliveryPerson</span>
            <span class="role-badge manager">Manager</span><br>
            <strong>Goal:</strong> Authenticate user and provide role-based access to system<br>
            <strong>Preconditions:</strong> User has registered account with valid credentials<br>
            <strong>Postconditions:</strong> User authenticated with JWT token and redirected to role-specific dashboard
        </div>

        <h2>üìä Sequence Diagram</h2>
        <svg viewBox="0 0 1150 900" xmlns="http://www.w3.org/2000/svg">
            <!-- Background -->
            <rect width="1150" height="900" fill="#fafafa"/>
            
            <!-- Title -->
            <text x="575" y="30" text-anchor="middle" font-size="20" font-weight="bold" fill="#2c3e50">
                Login Authentication Flow with JWT
            </text>
            
            <!-- Actors and Objects -->
            <!-- User/UI -->
            <rect x="50" y="60" width="100" height="40" fill="#e3f2fd" stroke="#1976d2" stroke-width="2" rx="5"/>
            <text x="100" y="85" text-anchor="middle" font-weight="bold">User/UI</text>
            <line x1="100" y1="100" x2="100" y2="850" stroke="#666" stroke-width="1" stroke-dasharray="5,5"/>
            
            <!-- AuthService -->
            <rect x="220" y="60" width="120" height="40" fill="#f3e5f5" stroke="#7b1fa2" stroke-width="2" rx="5"/>
            <text x="280" y="85" text-anchor="middle" font-weight="bold">AuthService</text>
            <line x1="280" y1="100" x2="280" y2="850" stroke="#666" stroke-width="1" stroke-dasharray="5,5"/>
            
            <!-- UserRepository -->
            <rect x="410" y="60" width="140" height="40" fill="#e8f5e9" stroke="#388e3c" stroke-width="2" rx="5"/>
            <text x="480" y="85" text-anchor="middle" font-weight="bold">UserRepository</text>
            <line x1="480" y1="100" x2="480" y2="850" stroke="#666" stroke-width="1" stroke-dasharray="5,5"/>
            
            <!-- JWTProvider -->
            <rect x="620" y="60" width="120" height="40" fill="#fff3e0" stroke="#f57c00" stroke-width="2" rx="5"/>
            <text x="680" y="85" text-anchor="middle" font-weight="bold">JWTProvider</text>
            <line x1="680" y1="100" x2="680" y2="850" stroke="#666" stroke-width="1" stroke-dasharray="5,5"/>
            
            <!-- SessionManager -->
            <rect x="810" y="60" width="130" height="40" fill="#fce4ec" stroke="#c2185b" stroke-width="2" rx="5"/>
            <text x="875" y="85" text-anchor="middle" font-weight="bold">SessionManager</text>
            <line x1="875" y1="100" x2="875" y2="850" stroke="#666" stroke-width="1" stroke-dasharray="5,5"/>
            
            <!-- RouterService -->
            <rect x="1000" y="60" width="120" height="40" fill="#e0f2f1" stroke="#00796b" stroke-width="2" rx="5"/>
            <text x="1060" y="85" text-anchor="middle" font-weight="bold">RouterService</text>
            <line x1="1060" y1="100" x2="1060" y2="850" stroke="#666" stroke-width="1" stroke-dasharray="5,5"/>
            
            <!-- Main Flow -->
            
            <!-- 1. Enter Credentials -->
            <line x1="100" y1="130" x2="100" y2="150" stroke="#333" stroke-width="2"/>
            <rect x="105" y="140" width="110" height="20" fill="#e3f2fd" stroke="#333" rx="3"/>
            <text x="160" y="153" text-anchor="middle" font-size="11">enterCredentials()</text>
            
            <!-- 2. Submit Login -->
            <line x1="100" y1="180" x2="280" y2="180" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
            <text x="190" y="175" text-anchor="middle" font-size="12">2: login(email, password)</text>
            
            <!-- 3. Validate Input -->
            <rect x="285" y="200" width="100" height="25" fill="#f3e5f5" stroke="#333" rx="3"/>
            <text x="335" y="217" text-anchor="middle" font-size="11">validateInput()</text>
            
            <!-- 4. Find User by Email -->
            <line x1="280" y1="250" x2="480" y2="250" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
            <text x="380" y="245" text-anchor="middle" font-size="12">4: findByEmail(email)</text>
            
            <!-- 5. Query Database -->
            <rect x="485" y="260" width="90" height="25" fill="#e8f5e9" stroke="#333" rx="3"/>
            <text x="530" y="277" text-anchor="middle" font-size="11">queryDB()</text>
            
            <!-- 6. Return User Object -->
            <line x1="480" y1="300" x2="280" y2="300" stroke="#333" stroke-width="2" stroke-dasharray="3,3" marker-end="url(#arrowhead)"/>
            <text x="380" y="295" text-anchor="middle" font-size="12">6: userObject</text>
            
            <!-- Alt: User Not Found -->
            <rect x="50" y="320" width="550" height="80" fill="none" stroke="#f44336" stroke-width="1" stroke-dasharray="5,5" rx="5"/>
            <text x="60" y="335" font-size="11" fill="#f44336" font-weight="bold">alt [user not found]</text>
            <line x1="280" y1="360" x2="100" y2="360" stroke="#f44336" stroke-width="2" stroke-dasharray="3,3" marker-end="url(#arrowhead-red)"/>
            <text x="190" y="355" text-anchor="middle" font-size="12" fill="#f44336">6a: error("Invalid credentials")</text>
            
            <!-- 7. Verify Password -->
            <rect x="285" y="420" width="110" height="25" fill="#f3e5f5" stroke="#333" rx="3"/>
            <text x="340" y="437" text-anchor="middle" font-size="11">verifyPassword()</text>
            
            <!-- Alt: Invalid Password -->
            <rect x="50" y="460" width="550" height="80" fill="none" stroke="#f44336" stroke-width="1" stroke-dasharray="5,5" rx="5"/>
            <text x="60" y="475" font-size="11" fill="#f44336" font-weight="bold">alt [invalid password]</text>
            <line x1="280" y1="500" x2="100" y2="500" stroke="#f44336" stroke-width="2" stroke-dasharray="3,3" marker-end="url(#arrowhead-red)"/>
            <text x="190" y="495" text-anchor="middle" font-size="12" fill="#f44336">7a: error("Invalid credentials")</text>
            
            <!-- Alt: Blacklisted User -->
            <rect x="50" y="550" width="550" height="80" fill="none" stroke="#ff9800" stroke-width="1" stroke-dasharray="5,5" rx="5"/>
            <text x="60" y="565" font-size="11" fill="#ff9800" font-weight="bold">alt [user.status == "blacklisted"]</text>
            <line x1="280" y1="590" x2="100" y2="590" stroke="#ff9800" stroke-width="2" stroke-dasharray="3,3" marker-end="url(#arrowhead-orange)"/>
            <text x="190" y="585" text-anchor="middle" font-size="12" fill="#ff9800">7b: error("Account blacklisted")</text>
            
            <!-- 8. Generate JWT Token -->
            <line x1="280" y1="650" x2="680" y2="650" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
            <text x="480" y="645" text-anchor="middle" font-size="12">8: generateToken(user_id, role)</text>
            
            <!-- 9. Create Token -->
            <rect x="685" y="660" width="100" height="25" fill="#fff3e0" stroke="#333" rx="3"/>
            <text x="735" y="677" text-anchor="middle" font-size="11">createJWT()</text>
            
            <!-- 10. Return Token -->
            <line x1="680" y1="700" x2="280" y2="700" stroke="#333" stroke-width="2" stroke-dasharray="3,3" marker-end="url(#arrowhead)"/>
            <text x="480" y="695" text-anchor="middle" font-size="12">10: jwt_token</text>
            
            <!-- 11. Create Session -->
            <line x1="280" y1="720" x2="875" y2="720" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
            <text x="577" y="715" text-anchor="middle" font-size="12">11: createSession(user_id, token)</text>
            
            <!-- 12. Store Session -->
            <rect x="880" y="730" width="90" height="25" fill="#fce4ec" stroke="#333" rx="3"/>
            <text x="925" y="747" text-anchor="middle" font-size="11">storeSession()</text>
            
            <!-- 13. Get Dashboard Route -->
            <line x1="280" y1="770" x2="1060" y2="770" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
            <text x="670" y="765" text-anchor="middle" font-size="12">13: getDashboardRoute(role)</text>
            
            <!-- 14. Return Route -->
            <line x1="1060" y1="790" x2="280" y2="790" stroke="#333" stroke-width="2" stroke-dasharray="3,3" marker-end="url(#arrowhead)"/>
            <text x="670" y="785" text-anchor="middle" font-size="12">14: dashboard_url</text>
            
            <!-- 15. Success Response -->
            <line x1="280" y1="810" x2="100" y2="810" stroke="#333" stroke-width="2" stroke-dasharray="3,3" marker-end="url(#arrowhead)"/>
            <text x="190" y="805" text-anchor="middle" font-size="12">15: success(token, redirect_url)</text>
            
            <!-- Role-based Redirect Box -->
            <rect x="105" y="825" width="200" height="20" fill="#4caf50" stroke="#333" rx="5"/>
            <text x="205" y="838" text-anchor="middle" font-size="11" fill="white" font-weight="bold">Redirect to Role Dashboard</text>
            
            <!-- Arrow definitions -->
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#333"/>
                </marker>
                <marker id="arrowhead-red" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#f44336"/>
                </marker>
                <marker id="arrowhead-orange" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#ff9800"/>
                </marker>
            </defs>
        </svg>

        <h2>üíª Detailed Pseudocode</h2>
        <div class="pseudocode"><span class="comment">// TrueBite Authentication System - UC-02 Login</span>
<span class="keyword">FUNCTION</span> login(email, password):
    <span class="keyword">INPUT:</span> {
        email: string (required)
        password: string (required)
    }
    
    <span class="comment">// Step 1: Input Validation</span>
    <span class="keyword">IF</span> email IS NULL OR email NOT matches email_pattern:
        <span class="keyword">RETURN</span> {
            success: false,
            error: "INVALID_INPUT",
            message: "Please enter a valid email address"
        }
    
    <span class="keyword">IF</span> password IS NULL OR length(password) < 1:
        <span class="keyword">RETURN</span> {
            success: false,
            error: "INVALID_INPUT",
            message: "Password is required"
        }
    
    <span class="comment">// Step 2: Find User by Email</span>
    user = UserRepository.findByEmail(email)
    
    <span class="keyword">IF</span> user IS NULL:
        <span class="comment">// Don't reveal if email exists for security</span>
        Logger.log("LOGIN_FAILED", {email: email, reason: "USER_NOT_FOUND"})
        <span class="keyword">RETURN</span> {
            success: false,
            error: "INVALID_CREDENTIALS",
            message: "Invalid email or password"
        }
    
    <span class="comment">// Step 3: Check User Status</span>
    <span class="keyword">IF</span> user.status == "blacklisted":
        Logger.log("LOGIN_BLOCKED", {user_id: user.user_id, reason: "BLACKLISTED"})
        <span class="keyword">RETURN</span> {
            success: false,
            error: "ACCOUNT_BLACKLISTED",
            message: "Your account has been suspended. Please contact support.",
            support_email: "support@truebite.com"
        }
    
    <span class="keyword">IF</span> user.status == "suspended":
        Logger.log("LOGIN_BLOCKED", {user_id: user.user_id, reason: "SUSPENDED"})
        <span class="keyword">RETURN</span> {
            success: false,
            error: "ACCOUNT_SUSPENDED",
            message: "Account temporarily suspended until " + user.suspension_end_date
        }
    
    <span class="comment">// Step 4: Verify Password</span>
    isValidPassword = verifyPassword(password, user.password_hash)
    
    <span class="keyword">IF NOT</span> isValidPassword:
        <span class="comment">// Track failed attempts for security</span>
        incrementFailedAttempts(user.user_id)
        
        <span class="keyword">IF</span> getFailedAttempts(user.user_id) >= MAX_LOGIN_ATTEMPTS:
            lockAccount(user.user_id, LOCK_DURATION_MINUTES)
            <span class="keyword">RETURN</span> {
                success: false,
                error: "ACCOUNT_LOCKED",
                message: "Too many failed attempts. Account locked for 15 minutes."
            }
        
        <span class="keyword">RETURN</span> {
            success: false,
            error: "INVALID_CREDENTIALS",
            message: "Invalid email or password"
        }
    
    <span class="comment">// Step 5: Generate JWT Token</span>
    tokenPayload = {
        user_id: user.user_id,
        email: user.email,
        role: user.role,
        name: user.name,
        issued_at: getCurrentTimestamp(),
        expires_at: getCurrentTimestamp() + JWT_EXPIRY_SECONDS
    }
    
    jwt_token = JWTProvider.generateToken(tokenPayload)
    
    <span class="comment">// Step 6: Create Session</span>
    session = SessionManager.createSession({
        user_id: user.user_id,
        token: jwt_token,
        ip_address: getClientIP(),
        user_agent: getUserAgent(),
        expires_at: tokenPayload.expires_at
    })
    
    <span class="comment">// Step 7: Determine Role-Based Redirect</span>
    redirect_url = RouterService.getDashboardRoute(user.role)
    
    <span class="comment">// Step 8: Update Last Login</span>
    UserRepository.updateLastLogin(user.user_id, getCurrentTimestamp())
    
    <span class="comment">// Step 9: Reset Failed Attempts</span>
    resetFailedAttempts(user.user_id)
    
    <span class="comment">// Step 10: Log Successful Login</span>
    Logger.log("LOGIN_SUCCESS", {
        user_id: user.user_id,
        role: user.role,
        timestamp: getCurrentTimestamp()
    })
    
    <span class="comment">// Step 11: Return Success Response</span>
    <span class="keyword">RETURN</span> {
        success: true,
        token: jwt_token,
        user: {
            id: user.user_id,
            email: user.email,
            name: user.name,
            role: user.role,
            is_vip: (user.role == "vip")
        },
        redirect_url: redirect_url,
        session_expires_at: session.expires_at
    }
    
<span class="keyword">END FUNCTION</span>

<span class="comment">// Helper Functions</span>
<span class="keyword">FUNCTION</span> verifyPassword(plainPassword, hashedPassword):
    <span class="keyword">RETURN</span> bcrypt.verify(plainPassword, hashedPassword)
<span class="keyword">END FUNCTION</span>

<span class="keyword">FUNCTION</span> getDashboardRoute(role):
    <span class="keyword">SWITCH</span> role:
        <span class="keyword">CASE</span> "customer":
            <span class="keyword">RETURN</span> "/customer/dashboard"
        <span class="keyword">CASE</span> "vip":
            <span class="keyword">RETURN</span> "/vip/dashboard"
        <span class="keyword">CASE</span> "chef":
            <span class="keyword">RETURN</span> "/chef/kitchen"
        <span class="keyword">CASE</span> "delivery":
            <span class="keyword">RETURN</span> "/delivery/orders"
        <span class="keyword">CASE</span> "manager":
            <span class="keyword">RETURN</span> "/manager/overview"
        <span class="keyword">DEFAULT:</span>
            <span class="keyword">RETURN</span> "/home"
<span class="keyword">END FUNCTION</span>
        </div>

        <h2>üî¥ Exception Scenarios</h2>
        <div class="error-box">
            <h3>E1: Invalid Credentials</h3>
            <p><strong>Trigger:</strong> Email doesn't exist or password doesn't match</p>
            <p><strong>Response:</strong></p>
            <ul>
                <li>Generic error message (don't reveal if email exists)</li>
                <li>Increment failed attempt counter</li>
                <li>Log security event</li>
                <li>No session created</li>
            </ul>
        </div>

        <div class="error-box">
            <h3>E2: Account Blacklisted</h3>
            <p><strong>Trigger:</strong> user.status == "blacklisted"</p>
            <p><strong>Response:</strong></p>
            <ul>
                <li>Access denied message</li>
                <li>Show support contact: support@truebite.com</li>
                <li>Log security event</li>
                <li>No session created</li>
            </ul>
        </div>

        <div class="error-box">
            <h3>E3: Account Locked (Too Many Attempts)</h3>
            <p><strong>Trigger:</strong> Failed attempts >= 5</p>
            <p><strong>Response:</strong></p>
            <ul>
                <li>Lock account for 15 minutes</li>
                <li>Show lockout message with timer</li>
                <li>Send security alert email</li>
            </ul>
        </div>

        <h2>üìã Message Specifications</h2>
        <table>
            <thead>
                <tr>
                    <th>Step</th>
                    <th>From</th>
                    <th>To</th>
                    <th>Method</th>
                    <th>Parameters</th>
                    <th>Response</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>2</td>
                    <td>UI</td>
                    <td>AuthService</td>
                    <td>login()</td>
                    <td>email, password</td>
                    <td>AuthResult</td>
                </tr>
                <tr>
                    <td>4</td>
                    <td>AuthService</td>
                    <td>UserRepository</td>
                    <td>findByEmail()</td>
                    <td>email</td>
                    <td>User object or null</td>
                </tr>
                <tr>
                    <td>8</td>
                    <td>AuthService</td>
                    <td>JWTProvider</td>
                    <td>generateToken()</td>
                    <td>user_id, role</td>
                    <td>JWT string</td>
                </tr>
                <tr>
                    <td>11</td>
                    <td>AuthService</td>
                    <td>SessionManager</td>
                    <td>createSession()</td>
                    <td>user_id, token</td>
                    <td>Session object</td>
                </tr>
                <tr>
                    <td>13</td>
                    <td>AuthService</td>
                    <td>RouterService</td>
                    <td>getDashboardRoute()</td>
                    <td>role</td>
                    <td>URL string</td>
                </tr>
            </tbody>
        </table>

        <h2>üéØ Role-Based Routing</h2>
        <div class="success-box">
            <h3>Dashboard URLs by Role:</h3>
            <ul>
                <li><span class="role-badge customer">Customer</span> ‚Üí <code>/customer/dashboard</code> (Browse menu, place orders, wallet)</li>
                <li><span class="role-badge vip">VIP</span> ‚Üí <code>/vip/dashboard</code> (Same as customer + discounts, priority)</li>
                <li><span class="role-badge chef">Chef</span> ‚Üí <code>/chef/kitchen</code> (View orders, update status, manage menu)</li>
                <li><span class="role-badge delivery">DeliveryPerson</span> ‚Üí <code>/delivery/orders</code> (Available orders, bid on deliveries)</li>
                <li><span class="role-badge manager">Manager</span> ‚Üí <code>/manager/overview</code> (All system controls, complaints, HR)</li>
            </ul>
        </div>

        <h2>üîí Security Features</h2>
        <div class="info-box">
            <ul>
                <li><strong>Password Security:</strong> Bcrypt hashing with salt</li>
                <li><strong>Rate Limiting:</strong> Max 5 login attempts, then 15-minute lockout</li>
                <li><strong>JWT Token:</strong> 
                    <ul>
                        <li>Expires in 24 hours</li>
                        <li>Contains user_id, role, email</li>
                        <li>Signed with RS256 algorithm</li>
                    </ul>
                </li>
                <li><strong>Session Management:</strong> Server-side session tracking</li>
                <li><strong>Audit Logging:</strong> All login attempts logged</li>
                <li><strong>IP Tracking:</strong> Detect suspicious login patterns</li>
            </ul>
        </div>

        <div class="info-box">
            <h3>JWT Token Structure:</h3>
            <pre style="background: #ecf0f1; padding: 10px; border-radius: 5px;">
{
  "header": {
    "alg": "RS256",
    "typ": "JWT"
  },
  "payload": {
    "user_id": "uuid-here",
    "email": "user@email.com",
    "role": "customer|vip|chef|delivery|manager",
    "name": "User Name",
    "iat": 1731888000,
    "exp": 1731974400
  },
  "signature": "base64-encoded-signature"
}</pre>
        </div>
    </div>
</body>
</html>